# 对话系统多段台词与多发言人功能说明

## 功能概述

本次更新为对话系统添加了两个重要功能：

1. **多段连续台词功能**：允许在一个对话节点中包含多句台词，玩家可以通过点击"继续"按钮逐句浏览
2. **多发言人功能**：每句台词都可以单独指定发言人，支持多个角色轮流发言

## 主要改进

### 1. DialogueNode 类改进

**原有结构：**
```csharp
public class DialogueNode : ScriptableObject
{
    public string speakerName;
    public string sentence;  // 单个台词
    public List<PlayerChoice> choices;
}
```

**新结构：**
```csharp
public class DialogueNode : ScriptableObject
{
    public string[] sentences = new string[1];  // 多段台词数组
    public string[] speakerNames = new string[1];  // 对应的发言人数组
    public string defaultSpeakerName = "";  // 默认发言人
    public List<PlayerChoice> choices;
    
    // 向后兼容的属性
    public string speakerName { get; set; }
    public string sentence { get; set; }
    
    // 新增方法
    public string GetSpeakerName(int index);  // 获取指定索引的发言人
    public bool IsValid();  // 验证数据完整性
}
```

### 2. DialogueManager 类改进

- 添加了 `currentSentenceIndex` 变量跟踪当前播放的句子
- 添加了 `isTyping` 变量防止在打字过程中重复点击
- 新增 `PlayNextSentence()` 方法处理多段台词播放逻辑
- 新增 `UpdateSpeakerName()` 方法动态更新发言人显示
- 新增 `OnContinueClicked()` 方法处理继续按钮点击事件
- 修改了 `ShowNode()` 方法以支持多段台词播放

### 3. 自定义编辑器

- 提供了友好的UI来管理多发言人对话节点
- 支持台词和发言人的同步管理
- 提供预览功能和验证信息
- 显示统计信息（有效台词数量、参与角色数量等）

## 使用方法

### 1. 创建对话节点

1. 在Project窗口中右键
2. 选择 `Create > Dialogue > Dialogue Node`
3. 设置默认发言人姓名
4. 在 `Sentences` 数组中添加多段台词
5. 在 `Speaker Names` 数组中设置对应的发言人

### 2. 设置多发言人台词

在Inspector中设置：

```
默认发言人: "村长"

台词1:
- 发言人: "村长"
- 台词内容: "你好，冒险者！"

台词2:
- 发言人: "冒险者"
- 台词内容: "你好，村长！"

台词3:
- 发言人: "" (空字符串，使用默认发言人)
- 台词内容: "欢迎来到我们的村庄。"

台词4:
- 发言人: "村长"
- 台词内容: "这里有很多有趣的任务等着你。"
```

### 3. 发言人设置规则

- **自定义发言人**：在 `speakerNames` 数组中填写具体的发言人姓名
- **默认发言人**：在 `speakerNames` 中留空（空字符串），系统会使用 `defaultSpeakerName`
- **自动同步**：台词数组和发言人数组会自动保持同步

### 4. 设置选择选项

在所有台词播放完毕后，系统会显示选择选项：

1. 在 `Choices` 列表中添加 `PlayerChoice`
2. 设置选择文本
3. 设置下一个对话节点
4. 设置事件类型（可选）

### 5. 在代码中使用

```csharp
// 启动对话
DialogueManager.Instance.StartDialogue(dialogueNode);

// 获取指定句子的发言人
string speaker = dialogueNode.GetSpeakerName(0);

// 验证节点有效性
bool isValid = dialogueNode.IsValid();
```

## 播放流程

1. **开始对话**：显示第一句台词和对应的发言人，开始打字效果
2. **逐句播放**：每句台词播放完毕后，如果还有更多台词，显示"继续"按钮
3. **动态更新发言人**：每句台词播放时都会更新UI中的发言人姓名
4. **玩家点击继续**：播放下一句台词
5. **所有台词播放完毕**：根据是否有选择选项决定下一步
   - 有选择：显示选择按钮
   - 无选择：显示"继续"按钮（结束对话）

## 向后兼容性

为了保持向后兼容性，系统提供了以下特性：

1. **属性兼容**：原有的 `speakerName` 和 `sentence` 字段现在作为属性存在
2. **自动迁移**：提供了迁移工具帮助将现有对话节点转换为新格式
3. **无缝升级**：现有的对话节点可以继续正常工作
4. **默认值处理**：未设置的发言人会自动使用默认发言人

## 迁移工具使用

### 自动迁移所有节点

1. 在Unity菜单栏选择 `Tools > Dialogue System > 迁移所有对话节点`
2. 系统会自动查找并迁移所有对话节点

### 批量设置发言人

1. 在Unity菜单栏选择 `Tools > Dialogue System > 批量设置发言人`
2. 输入要设置的发言人姓名
3. 系统会为所有对话节点设置默认发言人

### 验证所有节点

1. 在Unity菜单栏选择 `Tools > Dialogue System > 验证所有对话节点`
2. 系统会检查所有对话节点的有效性

### 手动迁移

1. 在Unity菜单栏选择 `Tools > Dialogue System > 创建迁移工具`
2. 在场景中创建迁移工具对象
3. 设置要迁移的对话节点
4. 运行迁移

## 示例场景

### 示例1：简单对话

```
默认发言人: 村长

台词1: 村长 - "你好，冒险者！"
台词2: 冒险者 - "你好，村长！"
台词3: 村长 - "欢迎来到我们的村庄。"
台词4: 村长 - "希望你能在这里找到你的冒险。"

选择:
- "我想了解任务" -> 任务对话节点
- "我想逛逛商店" -> 商店对话节点
```

### 示例2：复杂对话

```
默认发言人: 神秘商人

台词1: 神秘商人 - "啊，你终于来了..."
台词2: 神秘商人 - "我等你很久了。"
台词3: 冒险者 - "你是谁？"
台词4: 神秘商人 - "我是一个商人，专门收集稀有物品。"
台词5: 神秘商人 - "我有一个特殊的任务要交给你。"
台词6: 神秘商人 - "这个任务很危险，但报酬丰厚。"
台词7: 神秘商人 - "你愿意接受吗？"

选择:
- "我愿意接受" -> 接受任务节点
- "我需要考虑一下" -> 考虑节点
- "太危险了，我拒绝" -> 拒绝节点
```

### 示例3：多人对话

```
默认发言人: 村长

台词1: 村长 - "欢迎来到我们的村庄！"
台词2: 村民A - "你好，冒险者！"
台词3: 村民B - "我们这里有很多有趣的故事。"
台词4: 村长 - "是的，我们村庄有着悠久的历史。"
台词5: 冒险者 - "能告诉我一些吗？"
台词6: 村长 - "当然可以，让我为你介绍..."

选择:
- "我想了解更多历史" -> 历史对话节点
- "我想了解村庄现状" -> 现状对话节点
```

## 注意事项

1. **空句子处理**：系统会自动跳过空的台词句子
2. **发言人设置**：如果某句台词的发言人设置为空，会使用默认发言人
3. **打字效果**：每句台词都有打字效果，在打字过程中点击继续按钮会被忽略
4. **UI更新**：确保场景中有正确的UI元素（继续按钮、选择按钮容器等）
5. **性能考虑**：大量台词节点可能会影响性能，建议合理分段
6. **数据验证**：使用自定义编辑器可以验证对话节点的完整性

## 故障排除

### 问题1：发言人姓名不显示
- 检查 `DialogueManager` 中的 `speakerNameText` 引用是否正确设置
- 确保 `defaultSpeakerName` 已设置
- 检查 `speakerNames` 数组是否正确配置

### 问题2：继续按钮不显示
- 检查 `DialogueManager` 中的 `continueButton` 引用是否正确设置
- 确保按钮在Inspector中已分配

### 问题3：台词不播放
- 检查 `sentences` 数组是否为空
- 确保 `defaultSpeakerName` 已设置
- 检查 `DialogueManager` 是否正确初始化

### 问题4：选择选项不显示
- 检查 `choices` 列表是否为空
- 确保 `choiceButtonsContainer` 和 `choiceButtonPrefab` 已正确设置

### 问题5：发言人显示错误
- 检查 `speakerNames` 数组长度是否与 `sentences` 数组相同
- 确保发言人姓名设置正确
- 验证 `GetSpeakerName()` 方法是否正常工作

## 扩展功能

系统设计为可扩展的，未来可以添加的功能：

1. **台词音效**：为每句台词添加语音播放
2. **表情动画**：根据台词内容播放角色表情
3. **条件台词**：根据游戏状态显示不同的台词
4. **自动播放**：设置台词自动播放，无需玩家点击
5. **跳过功能**：允许玩家跳过当前台词直接显示选择
6. **角色头像**：为不同角色显示不同的头像
7. **语音识别**：支持语音输入进行对话选择

## 技术支持

如果在使用过程中遇到问题，请检查：

1. Unity控制台是否有错误信息
2. 对话节点的设置是否正确
3. UI元素的引用是否完整
4. 脚本是否正确编译
5. 使用自定义编辑器验证对话节点完整性

## 编辑器功能

### 自定义编辑器特性

1. **友好的UI界面**：提供清晰的分类和折叠面板
2. **同步管理**：台词数组和发言人数组自动同步
3. **预览功能**：可以预览完整的对话内容
4. **验证信息**：显示节点有效性和统计信息
5. **快速操作**：支持快速添加、删除台词

### 使用技巧

1. **使用预览功能**：在设置对话节点时，经常使用预览功能检查效果
2. **合理分组**：将相关的台词放在同一个节点中，提高管理效率
3. **命名规范**：为对话节点使用有意义的名称，便于管理
4. **定期验证**：使用验证功能检查所有对话节点的完整性

---

**版本**：2.0  
**更新日期**：2024年  
**兼容性**：Unity 2021.3+  
**新增功能**：多发言人支持、自定义编辑器、批量操作工具 